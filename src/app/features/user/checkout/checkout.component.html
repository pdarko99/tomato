<p-toast></p-toast>

<div class="checkout-container">
  <div class="page-header">
    <h1>Checkout</h1>
  </div>

  <p-steps [model]="steps" [activeIndex]="activeStep" [readonly]="true" styleClass="mb-4"></p-steps>

  <div class="checkout-layout">
    <div class="checkout-form">
      <form [formGroup]="checkoutForm">
        <!-- Step 1: Shipping -->
        @if (activeStep === 0) {
          <p-card>
            <ng-template #header>
              <div class="card-header">
                <i class="pi pi-map-marker"></i>
                <h3>Shipping Address</h3>
              </div>
            </ng-template>

            <div class="form-field">
              <label for="shippingAddress">Delivery Address</label>
              <textarea
                pTextarea
                id="shippingAddress"
                formControlName="shippingAddress"
                rows="4"
                placeholder="Enter your full shipping address including street, city, state, and zip code"
                [class.ng-invalid]="shippingAddress?.invalid && shippingAddress?.touched"
              ></textarea>
              @if (shippingAddress?.invalid && shippingAddress?.touched) {
                <small class="p-error">Please enter a valid shipping address (at least 10 characters)</small>
              }
            </div>

            <div class="step-actions">
              <p-button
                label="Back to Cart"
                icon="pi pi-arrow-left"
                [text]="true"
                routerLink="/cart"
              ></p-button>
              <p-button
                label="Continue to Payment"
                icon="pi pi-arrow-right"
                iconPos="right"
                styleClass="btn-tomato"
                (onClick)="nextStep()"
              ></p-button>
            </div>
          </p-card>
        }

        <!-- Step 2: Payment -->
        @if (activeStep === 1) {
          <p-card>
            <ng-template #header>
              <div class="card-header">
                <i class="pi pi-credit-card"></i>
                <h3>Payment Information</h3>
              </div>
            </ng-template>

            <div class="payment-form">
              <div class="form-field">
                <label for="cardHolderName">Cardholder Name</label>
                <input
                  pInputText
                  id="cardHolderName"
                  formControlName="cardHolderName"
                  placeholder="Name on card"
                  [class.ng-invalid]="cardHolderName?.invalid && cardHolderName?.touched"
                />
                @if (cardHolderName?.invalid && cardHolderName?.touched) {
                  <small class="p-error">Cardholder name is required</small>
                }
              </div>

              <div class="form-field">
                <label for="cardNumber">Card Number</label>
                <p-inputMask
                  id="cardNumber"
                  formControlName="cardNumber"
                  mask="9999 9999 9999 9999"
                  placeholder="1234 5678 9012 3456"
                  [unmask]="true"
                  styleClass="w-full"
                ></p-inputMask>
                @if (cardNumber?.invalid && cardNumber?.touched) {
                  <small class="p-error">Valid card number is required</small>
                }
              </div>

              <div class="form-row">
                <div class="form-field">
                  <label for="expiryDate">Expiry Date</label>
                  <p-inputMask
                    id="expiryDate"
                    formControlName="expiryDate"
                    mask="99/99"
                    placeholder="MM/YY"
                    styleClass="w-full"
                  ></p-inputMask>
                  @if (expiryDate?.invalid && expiryDate?.touched) {
                    <small class="p-error">Required</small>
                  }
                </div>

                <div class="form-field">
                  <label for="cvv">CVV</label>
                  <p-inputMask
                    id="cvv"
                    formControlName="cvv"
                    mask="999"
                    placeholder="123"
                    styleClass="w-full"
                  ></p-inputMask>
                  @if (cvv?.invalid && cvv?.touched) {
                    <small class="p-error">Required</small>
                  }
                </div>
              </div>
            </div>

            <div class="step-actions">
              <p-button
                label="Back"
                icon="pi pi-arrow-left"
                [text]="true"
                (onClick)="prevStep()"
              ></p-button>
              <p-button
                label="Review Order"
                icon="pi pi-arrow-right"
                iconPos="right"
                styleClass="btn-tomato"
                (onClick)="nextStep()"
              ></p-button>
            </div>
          </p-card>
        }

        <!-- Step 3: Confirm -->
        @if (activeStep === 2) {
          <p-card>
            <ng-template #header>
              <div class="card-header">
                <i class="pi pi-check-circle"></i>
                <h3>Review & Confirm</h3>
              </div>
            </ng-template>

            <div class="review-section">
              <h4>Shipping Address</h4>
              <p class="review-value">{{ shippingAddress?.value }}</p>
            </div>

            <p-divider></p-divider>

            <div class="review-section">
              <h4>Payment Method</h4>
              <p class="review-value">
                <i class="pi pi-credit-card"></i>
                Card ending in {{ cardNumber?.value?.slice(-4) }}
              </p>
            </div>

            <p-divider></p-divider>

            <div class="review-section">
              <h4>Order Items</h4>
              @for (item of cartService.cartItems(); track item.product.id) {
                <div class="review-item">
                  <span>{{ item.product.title }} x {{ item.quantity }}</span>
                  <span>${{ (item.product.price * item.quantity).toFixed(2) }}</span>
                </div>
              }
            </div>

            <div class="step-actions">
              <p-button
                label="Back"
                icon="pi pi-arrow-left"
                [text]="true"
                (onClick)="prevStep()"
              ></p-button>
              <p-button
                label="Place Order"
                icon="pi pi-check"
                styleClass="btn-tomato"
                [loading]="loading"
                (onClick)="placeOrder()"
              ></p-button>
            </div>
          </p-card>
        }
      </form>
    </div>

    <div class="order-summary">
      <p-card>
        <ng-template #header>
          <div class="summary-header">
            <h3>Order Summary</h3>
          </div>
        </ng-template>

        <div class="summary-items">
          @for (item of cartService.cartItems(); track item.product.id) {
            <div class="summary-item">
              <img [src]="item.product.productUrl" [alt]="item.product.title" />
              <div class="item-info">
                <span class="item-name">{{ item.product.title }}</span>
                <span class="item-qty">Qty: {{ item.quantity }}</span>
              </div>
              <span class="item-price">${{ (item.product.price * item.quantity).toFixed(2) }}</span>
            </div>
          }
        </div>

        <p-divider></p-divider>

        <div class="summary-totals">
          <div class="summary-row">
            <span>Subtotal</span>
            <span>${{ cartService.cartTotal().toFixed(2) }}</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span class="free">FREE</span>
          </div>
          <div class="summary-row">
            <span>Tax (8%)</span>
            <span>${{ (cartService.cartTotal() * 0.08).toFixed(2) }}</span>
          </div>
          <p-divider></p-divider>
          <div class="summary-row total">
            <span>Total</span>
            <span class="price">${{ getTotalWithTax().toFixed(2) }}</span>
          </div>
        </div>
      </p-card>
    </div>
  </div>
</div>
